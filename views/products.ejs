<%- include("partials/header.ejs") %>  <!-- Include header from partials -->



    <!-- Page Header -->
    <section class="page-header">
        <div class="container">
            <h1 class="page-title">All Marketplace Products</h1>
            <p class="page-subtitle">Browse our complete collection of farm-fresh produce at honest prices</p>
            <nav class="breadcrumb">
                <a href="/" class="breadcrumb-link">Home</a>
                <span class="breadcrumb-separator">/</span>
                <span class="breadcrumb-current">All Products</span>
            </nav>
        </div>
    </section>

    <!-- All Products Section -->
    <section id="all-products" class="marketplace">
        <div class="container">
            <div class="section-header">
                <div>
                    <h2 class="section-title">Fresh Marketplace</h2>
                    <p class="section-subtitle">Farm-fresh produce at honest prices</p>
                </div>
                <div class="filter-tabs">
                    <button class="filter-btn active">All</button>
                    <button class="filter-btn">Vegetables</button>
                    <button class="filter-btn">Fruits</button>
                    <button class="filter-btn">Dairy</button>
                    <button class="filter-btn">Grains</button>
                </div>
            </div>
            <div class="product-grid">
                <% if (products && products.length > 0) { %>
                    <% products.forEach(product => { %>
                        <% 
                            const price = Number(product.price) || 0;
                            const marketPrice = Number(product.market_price) || null;
                            const savings = marketPrice && price
                                ? Math.round((1 - price / marketPrice) * 100)
                                : 0;
                            const stockQty = Number(product.stock_quantity) || 0;
                            const firstLetter = (product.name || 'P').toString().charAt(0).toUpperCase();
                            const category = (product.category || 'Other').toString();
                        %>
                        <div class="product-card" data-category="<%= category %>">
                            <a href="/product/<%= product.id %>">
                                <div class="product-image">
                                     <img src="<%= product.image_url ? product.image_url : '/uploads/default-product.png' %>" 
                                         alt="<%= product.name %>" 
                                         onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 width=%27300%27 height=%27200%27%3E%3Crect fill=%27%23e8f5e9%27 width=%27300%27 height=%27200%27/%3E%3Ctext fill=%27%232ecc71%27 font-family=%27Arial%27 font-size=%2716%27 x=%2750%25%27 y=%2750%25%27 dominant-baseline=%27middle%27 text-anchor=%27middle%27%3E<%= firstLetter %>%3C/text%3E%3C/svg%3E'">
                                    <div class="product-badges">
                                        <% if (product.is_verified) { %>
                                            <span class="badge badge-verified"><i class="fas fa-snowflake"></i> Verified</span>
                                        <% } %>
                                        <span class="badge badge-fresh"><i class="fas fa-leaf"></i> Fresh Arrival</span>
                                    </div>
                                    <button class="wishlist-btn"><i class="far fa-heart"></i></button>
                                </div>
                            </a>
                            <div class="product-info">
                                <h3 class="product-name"><a href="/product/<%= product.id %>"><%= product.name %></a></h3>
                                <p class="product-origin">Grown by <a href="/farmer/<%= product.farmer_id %>" class="farmer-link"><%= product.farm_name || 'Local Farm' %></a></p>
                                <div class="product-pricing">
                                    <span class="farm-price">৳<%= price %>/<%= product.unit || 'kg' %></span>
                                    <% if (marketPrice) { %>
                                        <span class="market-price">৳<%= marketPrice %>/<%= product.unit || 'kg' %></span>
                                        <span class="savings">Save <%= savings %>%</span>
                                    <% } %>
                                </div>
                                <p style="font-size: 0.9rem; color: #666; margin: 5px 0;">Stock: <%= stockQty %> available</p>
                                <button class="btn btn-primary btn-block" onclick="addToCartFromGrid(<%= product.id %>)">Add to Cart</button>
                            </div>
                        </div>
                    <% }); %>
                <% } else { %>
                    <div style="grid-column: 1/-1; text-align: center; padding: 40px;">
                        <p style="font-size: 1.2rem; color: #666;">No products available yet.</p>
                        <p>Check back soon for fresh farm products!</p>
                    </div>
                <% } %>
            </div>
        </div>
    </section>

<script>
    // Mobile navigation toggle
    const navToggle = document.querySelector('.nav-toggle');
    const navMenu = document.querySelector('.nav-menu');
    const navActions = document.querySelector('.nav-actions');
    
    if (navToggle && navMenu && navActions) {
        navToggle.addEventListener('click', function() {
            navMenu.classList.toggle('active');
            navActions.classList.toggle('active');
        });
    }

    // Category filter functionality (works for all users)
    (function() {
        const tabs = document.querySelectorAll('.filter-btn');
        const cards = document.querySelectorAll('.product-card');
        function normalize(str){ return (str || '').toString().trim().toLowerCase(); }
        function setActive(tab){
            tabs.forEach(t => t.classList.toggle('active', t === tab));
        }
        function applyFilter(cat){
            const target = normalize(cat);
            cards.forEach(card => {
                const c = normalize(card.getAttribute('data-category'));
                const show = target === 'all' || c === target;
                card.style.display = show ? '' : 'none';
            });
        }
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const label = tab.textContent || 'All';
                setActive(tab);
                applyFilter(label);
            });
        });
        // Initialize to currently active tab
        const initial = Array.from(tabs).find(t => t.classList.contains('active')) || tabs[0];
        if (initial) {
            applyFilter(initial.textContent || 'All');
        }
    })();

    // Smooth scroll for anchor links
    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener('click', function (e) {
            e.preventDefault();
            const target = document.querySelector(this.getAttribute('href'));
            if (target) {
                target.scrollIntoView({
                    behavior: 'smooth'
                });
            }
        });
    });

    // Add to Cart from grid
    async function addToCartFromGrid(productId) {
        try {
            const response = await fetch('/cart/add', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    productId: productId,
                    quantity: 1
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                // Product added to cart successfully; update cart badge
                updateCartBadge();
                // Optionally redirect to cart or refresh
                // window.location.href = '/cart';
            } else {
                if (response.status === 401) {
                    window.location.href = '/login';
                } else {
                    alert(data.message || 'Failed to add to cart');
                }
            }
        } catch (err) {
            console.error('Error adding to cart:', err);
            alert('Error adding to cart');
        }
    }

    // Increment cart badge without reload
    function updateCartBadge() {
        const cartBtn = document.querySelector('.btn.btn-icon[aria-label="Cart"]');
        if (!cartBtn) return;

        let badge = cartBtn.querySelector('.cart-count');
        if (!badge) {
            badge = document.createElement('span');
            badge.className = 'cart-count';
            badge.textContent = '1';
            cartBtn.appendChild(badge);
            return;
        }

        const current = parseInt(badge.textContent || '0', 10);
        const next = isNaN(current) ? 1 : current + 1;
        badge.textContent = next;
    }

</script>

<%- include("partials/footer.ejs") %>  <!-- Include footer from partials -->