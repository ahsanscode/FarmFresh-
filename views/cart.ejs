<%- include('partials/header') %> <!-- Include the header partial -->

    <!-- Page Header -->
    <section class="page-header">
        <div class="container">
            <h1 class="page-title"><i class="fas fa-shopping-cart"></i> Shopping Cart</h1>
            <p class="page-subtitle">Review your items and proceed to checkout</p>
            <nav class="breadcrumb">
                <a href="/" class="breadcrumb-link">Home</a>
                <span class="breadcrumb-separator">/</span>
                <span class="breadcrumb-current">Cart</span>
            </nav>
        </div>
    </section>

    <!-- Cart Section -->
    <section class="cart-page">
        <div class="container">
            <div class="cart-layout">
                <!-- Cart Items -->
                <div class="cart-items-section">
                    <h2 class="section-title">Cart Items (<%= cartItems.length %>)</h2>
                    
                    <% if (!cartItems || cartItems.length === 0) { %>
                        <div style="text-align:center; padding:60px 20px;">
                            <i class="fas fa-shopping-cart" style="font-size:60px; color:#ddd; margin-bottom:20px; display:block;"></i>
                            <p style="font-size:1.2rem; color:#666;">Your cart is empty</p>
                            <p style="color:#999; margin-bottom:20px;">Start shopping to add items to your cart</p>
                            <a href="/products" class="btn btn-primary">Continue Shopping</a>
                        </div>
                    <% } else { %>
                        <% cartItems.forEach(item => { %>
                            <div class="cart-item" data-cart-id="<%= item.id %>">
                                <img src="<%= item.image_url || 'data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 width=%27120%27 height=%27120%27%3E%3Crect fill=%27%23e8f5e9%27 width=%27120%27 height=%27120%27/%3E%3Ctext fill=%27%232ecc71%27 font-family=%27Arial%27 font-size=%2740%27 x=%2750%25%27 y=%2750%25%27 dominant-baseline=%27middle%27 text-anchor=%27middle%27%3EðŸ“¦%3C/text%3E%3C/svg%3E' %>" alt="<%= item.name %>" style="max-width:100%; max-height:100%;">
                                <div class="cart-item-details">
                                    <h3><a href="/product/<%= item.product_id %>" style="text-decoration:none; color:inherit;"><%= item.name %></a></h3>
                                    <p class="item-farmer">by <a href="/farmer/<%= item.farmer_id %>" style="text-decoration:none; color:inherit;"><%= item.farm_name %></a></p>
                                    <p class="item-price">à§³<%= item.price %>/<%= item.unit || 'kg' %></p>
                                </div>
                                <div class="cart-item-actions">
                                    <div class="quantity-control">
                                        <button class="qty-btn" onclick="updateQuantity(<%= item.id %>, -1)"><i class="fas fa-minus"></i></button>
                                        <input type="number" class="qty-input" value="<%= item.quantity %>" min="1" id="qty-<%= item.id %>" data-cart-id="<%= item.id %>">
                                        <button class="qty-btn" onclick="updateQuantity(<%= item.id %>, 1)"><i class="fas fa-plus"></i></button>
                                    </div>
                                    <div class="item-total">à§³<%= item.subtotal %></div>
                                    <button class="btn-remove" onclick="removeItem(<%= item.id %>)"><i class="fas fa-trash"></i></button>
                                </div>
                            </div>
                        <% }) %>
                    <% } %>
                </div>

                <!-- Order Summary & Checkout -->
                <div class="cart-summary-section">
                    <div class="order-summary">
                        <h3>Order Summary</h3>
                        <div class="summary-row">
                            <span>Subtotal (<%= cartItems.length %> <%= cartItems.length === 1 ? 'item' : 'items' %>)</span>
                            <span>à§³<%= totalPrice %></span>
                        </div>
                        <div class="summary-row">
                            <span>Delivery Fee</span>
                            <span>à§³50</span>
                        </div>
                        <div class="summary-row">
                            <span>Quality Assurance</span>
                            <span class="free-badge">FREE</span>
                        </div>
                        <div class="summary-divider"></div>
                        <div class="summary-row total">
                            <span>Total</span>
                            <span>à§³<%= totalPrice + 50 %></span>
                        </div>

                        <!-- Payment Options -->
                        <div class="payment-section">
                            <h4>Select Payment Method</h4>
                            
                            <div class="payment-option">
                                <input type="radio" id="cod" name="payment" value="cod" checked>
                                <label for="cod">
                                    <i class="fas fa-money-bill-wave"></i>
                                    <div>
                                        <strong>Cash on Delivery</strong>
                                        <p>Pay when you receive</p>
                                    </div>
                                </label>
                            </div>

                            <div class="payment-option">
                                <input type="radio" id="bkash" name="payment" value="bkash">
                                <label for="bkash">
                                    <i class="fas fa-mobile-alt" style="color: #E2136E;"></i>
                                    <div>
                                        <strong>bKash</strong>
                                        <p>Mobile payment</p>
                                    </div>
                                </label>
                            </div>

                            <div class="payment-option">
                                <input type="radio" id="nagad" name="payment" value="nagad">
                                <label for="nagad">
                                    <i class="fas fa-mobile-alt" style="color: #EC1C24;"></i>
                                    <div>
                                        <strong>Nagad</strong>
                                        <p>Mobile payment</p>
                                    </div>
                                </label>
                            </div>

                            <div class="payment-option">
                                <input type="radio" id="card" name="payment" value="card">
                                <label for="card">
                                    <i class="fas fa-credit-card"></i>
                                    <div>
                                        <strong>Credit/Debit Card</strong>
                                        <p>Visa, Mastercard, Amex</p>
                                    </div>
                                </label>
                            </div>

                            <div class="payment-option">
                                <input type="radio" id="bank" name="payment" value="bank">
                                <label for="bank">
                                    <i class="fas fa-university"></i>
                                    <div>
                                        <strong>Bank Transfer</strong>
                                        <p>Direct bank transfer</p>
                                    </div>
                                </label>
                            </div>
                        </div>

                        <% if (cartItems.length > 0) { %>
                            <button class="btn btn-primary btn-block btn-checkout">
                                <i class="fas fa-lock"></i> Proceed to Checkout
                            </button>
                        <% } %>

                        <div class="secure-checkout">
                            <i class="fas fa-shield-alt"></i> Secure checkout with SSL encryption
                        </div>
                    </div>

                    <!-- Promo Code -->
                    <div class="promo-code">
                        <h4>Have a promo code?</h4>
                        <div class="promo-input-group">
                            <input type="text" placeholder="Enter code">
                            <button class="btn btn-outline">Apply</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

<script>
    // Mobile navigation toggle
    const navToggle = document.querySelector('.nav-toggle');
    const navMenu = document.querySelector('.nav-menu');
    const navActions = document.querySelector('.nav-actions');
    
    if (navToggle && navMenu && navActions) {
        navToggle.addEventListener('click', function() {
            navMenu.classList.toggle('active');
            navActions.classList.toggle('active');
        });
    }

    // Update quantity
    async function updateQuantity(cartId, change) {
        const qtyInput = document.getElementById('qty-' + cartId);
        let currentQty = parseInt(qtyInput.value);
        const newQty = Math.max(1, currentQty + change);
        
        try {
            const response = await fetch('/cart/update', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    cartId: cartId,
                    quantity: newQty
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                qtyInput.value = newQty;
                location.reload(); // Reload to update totals
            } else {
                alert(data.message || 'Failed to update quantity');
                qtyInput.value = currentQty;
            }
        } catch (err) {
            console.error('Error updating quantity:', err);
            alert('Error updating quantity');
            qtyInput.value = currentQty;
        }
    }

    // Remove item
    async function removeItem(cartId) {
        if (confirm('Remove this item from cart?')) {
            try {
                const response = await fetch('/cart/remove/' + cartId, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Remove the cart item element
                    const cartItem = document.querySelector(`[data-cart-id="${cartId}"]`);
                    if (cartItem) {
                        cartItem.remove();
                    }
                    location.reload(); // Reload to update totals
                } else {
                    alert(data.message || 'Failed to remove item');
                }
            } catch (err) {
                console.error('Error removing item:', err);
                alert('Error removing item from cart');
            }
        }
    }
</script>

<%- include('partials/footer') %> <!-- Include the footer partial -->